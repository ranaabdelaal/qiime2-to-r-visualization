---
title: "Beta Diversity Visualizations"
output: html_notebook
---

```{r}
# ---- Set Working Directory ----

# Set your own working directory here
setwd("path/to/your/folder/R-beta")

# Print the current working directory to confirm
getwd()

```

```{r}
# ---- Install and Load Required Packages ----

# Install and load qiime2R if not already installed
if (!requireNamespace("qiime2R", quietly = TRUE)) {
  install.packages("qiime2R")
}
library(qiime2R)

# ---- Install and Load tidyverse ----

# Install tidyverse if not already installed
if (!requireNamespace("tidyverse", quietly = TRUE)) {
  install.packages("tidyverse")
}

# Load tidyverse
library(tidyverse)
library(ggplot2)
library(reshape2)

# ---- Install and Load vegan ----

# Install vegan if not already installed
if (!requireNamespace("vegan", quietly = TRUE)) {
  install.packages("vegan")
}

# Load vegan (used for ecological analysis, including PERMANOVA via adonis2)
library(vegan)
```

```{r}
# ---- Import Distance Matrix ----

# Read the distance matrix exported from QIIME2 (.qza file)
# Set your own path to the distance matrix file here
bray_curtis <- read_qza("path/to/bray_curtis_distance_matrix.qza")

# Extract the distance matrix as a standard R matrix
dist_matrix <- as.matrix(bray_curtis$data)

# Optionally convert it into a 'dist' object (useful for stats functions, e.g., PERMANOVA)
dist_object <- as.dist(dist_matrix)

# Print dimensions to verify
print(dim(dist_matrix))

```

```{r}
# --- Import Metadata for Visualization ---

# Read metadata file (tab-delimited, sample IDs as first column)
metadata <- read.table("sample-metadata.tsv", 
                       header = TRUE, 
                       sep = "\t", 
                       row.names = 1)

# Print column names to verify
print("Column names in metadata:")
print(colnames(metadata))

```

```{r}
# --- Read Distance Matrix and Metadata ---

# Read the distance matrix (from QIIME2 .qza file)
dist_matrix <- qiime2R::read_qza("bray_curtis_distance_matrix.qza")$data
dist_object <- as.dist(dist_matrix)  # Convert to 'dist' object

# Import metadata
metadata <- readr::read_tsv("sample-metadata.tsv")

# Ensure sample IDs match the distance matrix
metadata <- metadata %>%
  filter(`#SampleID` %in% rownames(as.matrix(dist_object))) %>%
  column_to_rownames("#SampleID")

# Reorder metadata to match distance matrix order
metadata <- metadata[rownames(as.matrix(dist_object)), ]

```

```{r}
# --- Define Groups for Pairwise PERMANOVA ---

# Define the groups you want to compare (replace with your actual group names)
groups <- c("GroupA", "GroupB")  

# Define the metadata column that contains the grouping variable
group_column <- "group"  

# Initialize an empty dataframe to store PERMANOVA results
pairwise_results <- data.frame(
  Comparison = character(),
  F_Value    = numeric(),
  R2         = numeric(),
  p_value    = numeric(),
  p_adj      = numeric(),
  stringsAsFactors = FALSE
)

print("Initialized results table for pairwise PERMANOVA:")
print(pairwise_results)

```

```{r}
# --- Pairwise PERMANOVA Across All Groups ---

# Get all unique groups from metadata
groups <- unique(metadata[[group_column]])

# Initialize results table
pairwise_results <- data.frame(
  Comparison = character(),
  F_Value    = numeric(),
  R2         = numeric(),
  p_value    = numeric(),
  p_adj      = numeric(),
  stringsAsFactors = FALSE
)

# Perform pairwise PERMANOVA
for (i in 1:(length(groups) - 1)) {
  for (j in (i + 1):length(groups)) {
    group1 <- groups[i]
    group2 <- groups[j]
    
    # Subset metadata and distance matrix
    subset_samples <- metadata[[group_column]] %in% c(group1, group2)
    subset_dist <- as.dist(as.matrix(dist_object)[subset_samples, subset_samples])
    subset_meta <- metadata[subset_samples, ]
    
    # Run PERMANOVA
    permanova <- adonis2(subset_dist ~ subset_meta[[group_column]], 
                         data = subset_meta, permutations = 999)
    
    # Store results
    pairwise_results <- rbind(pairwise_results, data.frame(
      Comparison = paste(group1, "vs", group2),
      F_Value    = permanova$F[1],
      R2         = permanova$R2[1],
      p_value    = permanova$`Pr(>F)`[1],
      p_adj      = NA  # Placeholder for adjustment
    ))
  }
}

# Adjust p-values (Benjamini-Hochberg correction)
pairwise_results$p_adj <- p.adjust(pairwise_results$p_value, method = "BH")

# Display results
print(pairwise_results)

```

```{r}
# --- PCoA Plot for Beta Diversity ---

# Run PCoA
pcoa <- cmdscale(dist_object, eig = TRUE)
scores <- data.frame(
  Sample = rownames(pcoa$points),
  PC1    = pcoa$points[, 1],
  PC2    = pcoa$points[, 2],
  Group  = metadata[[group_column]]
)

# Define a color palette (generic, user can modify)
palette_colors <- RColorBrewer::brewer.pal(n = length(unique(scores$Group)), "Set1")

# Plot with transparent ellipses (only edges)
ggplot(scores, aes(x = PC1, y = PC2, color = Group, fill = Group)) +
  geom_point(size = 3, alpha = 0.8) +  # Semi-transparent points
  
  # Ellipses (transparent fill, colored edges)
  stat_ellipse(
    geom     = "polygon",
    alpha    = 0,
    level    = 0.95,
    type     = "t",       # Robust method
    segments = 100,
    npoints  = 100
  ) +
  
  # Apply generic palette
  scale_color_manual(values = palette_colors) +
  scale_fill_manual(values = palette_colors) +
  
  labs(
    title = "PCoA: Beta Diversity by Group",
    x = paste0("PC1 (", round(100 * pcoa$eig[1] / sum(pcoa$eig), 2), "%)"),
    y = paste0("PC2 (", round(100 * pcoa$eig[2] / sum(pcoa$eig), 2), "%)")
  ) +
  
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5, color = "#222222"),
    legend.position = "right",
    panel.grid.major = element_line(color = "grey90"),
    panel.background = element_rect(fill = "white", color = NA),
    plot.background  = element_rect(fill = "white", color = NA)
  )

```

```{r}
# --- Save High-Resolution PCoA Plot ---
ggsave(
  filename = "PCoA_BetaDiversity.png",  # Output filename
  plot     = last_plot(),               # Saves the most recent ggplot
  width    = 8, 
  height   = 6, 
  dpi      = 600,                       # High resolution for publication
  bg       = "white"                    # Ensure background is white
)

```

```{r}
# Note:
# The same workflow applies for other distance metrics 
# (e.g., Jaccard, Weighted UniFrac, Unweighted UniFrac). 
# Simply replace the input distance matrix (.qza file) with the 
# corresponding exported distance matrix from QIIME2, and rerun the code.

```

